# Отчёт по доработке дипломной работы "Дипломный практикум в Yandex.Cloud"

> ФИО: Асадбеков Асадбек Давлятбекович\
> Программа обучения: DevOps-инженер\
> Группа: FOPS-29\
> Данный документ описывает доработки, выполненные по итогам проверки дипломной работы и замечаний дипломного руководителя.

---

## 1. Terraform

### 1.1 Дублирование ресурсов (subnet)

**Проблема:**  
- Подсети в Terraform-модуле VPC описывались как отдельные ресурсы с дублирующейся логикой, что снижало масштабируемость и усложняло поддержку конфигурации.

**Решение:**  
- Подсети переведены на использование переменной типа `map(object)` с созданием ресурсов через `for_each`:

```hcl
resource "yandex_vpc_subnet" "this" {
  for_each = var.subnets

  name           = "${var.project_name}-${each.key}"
  zone           = each.value.zone
  v4_cidr_blocks = [each.value.cidr]
  network_id     = yandex_vpc_network.network.id
}
```

**Результат:**  
- устранено дублирование конфигурации  
- упрощено добавление и изменение подсетей  
- конфигурация приведена к рекомендуемым практикам Terraform

---

### 1.2 Избыточные правила Security Group

**Проблема:**  
- В Security Group присутствовали дублирующие ingress/egress правила (например, несколько SSH-правил и egress, перекрываемые общим разрешением).

**Решение:**  
- удалены дублирующие и неиспользуемые правила  
- оставлен минимально необходимый набор разрешений для Kubernetes-кластера

**Результат:**  
- Security Group стала более компактной и читаемой без потери функциональности.

---

### 1.3 Использование count для worker-нод

**Проблема:**  
- Использование `count` формирует массив ресурсов, что усложняет точечное управление нодами.

**Решение:**  
- В рамках учебного проекта использование `count` оставлено осознанно, так как количество worker-нод фиксировано и не предполагается динамическое масштабирование.
- Замечания приняты и зафиксированы как рекомендации для production-проектов, где предпочтительнее использование `for_each` с `map`.

---

### 1.4 Публичные IP-адреса Kubernetes-нод

**Проблема:**  
- В production-проектах ноды Kubernetes обычно размещаются в приватных подсетях.

**Решение:**  
- Публичные IP сохранены осознанно.

**Обоснование:**  
- учебный характер проекта  
- упрощение администрирования и отладки  
- данное допущение зафиксировано в документации

---

## 2. Kubernetes

**Проблема:**  
- В README была описана структура директорий с манифестами, но часть файлов отсутствовала или была размещена вне указанных каталогов.

**Решение:**  
- структура репозитория приведена в соответствие документации  
- манифесты и скриншоты распределены по соответствующим директориям  
- README обновлён

**Результат:**  
- Документация полностью соответствует фактическому содержимому репозитория.

---

## 3. Application (Docker)

### 3.1 Плавающий тег базового образа

**Проблема:**  
- Использование `nginx:alpine` может приводить к непредсказуемым изменениям образа.

**Решение:**  
- Использован фиксированный тег базового образа:

```dockerfile
FROM nginx:1.25.4-alpine
```

**Обоснование:**
- Фиксация версии базового образа обеспечивает воспроизводимость сборок, предсказуемость CI/CD-пайплайна и исключает неявные изменения окружения при повторных деплоях.
---

### 3.2 Неиспользуемый entrypoint

**Проблема:**
- Файл entrypoint.sh не использовался и являлся остатком предыдущей версии.

**Решение:**

- entrypoint.sh удалён
- Dockerfile упрощён

---

### 3.3 `ConfigMap` — вынос контента из образа

**Проблема:**  
- HTML-контент приложения был жёстко встроен в Docker-образ, что требовало пересборки образа и повторного деплоя даже при незначительных изменениях пользовательского интерфейса.

**Решение:**  
- Пользовательский контент был вынесен в `ConfigMap`, который монтируется в контейнер как `volume`.

**Обоснование:**  
- Такой подход позволяет обновлять контент без пересборки Docker-образа, сокращает время деплоя и разделяет ответственность между кодом приложения и его конфигурацией, что соответствует принципам Kubernetes.

---

## 4. CI/CD

### 4.1 Деплой при каждом запуске pipeline

**Проблема:**
- Деплой приложения выполнялся при любом пуше в ветку `main`, что не соответствует best practices и может приводить к непреднамеренному обновлению окружения.

**Решение:**  
CI/CD-пайплайн был переработан таким образом, что этап деплоя в Kubernetes выполняется только при создании Git-тега версии:

```yaml
deploy:
  if: startsWith(github.ref, 'refs/tags/')
```
**Обоснование:**
- Деплой по тегу обеспечивает явный контроль релизов, отделяет этапы сборки и поставки, а также соответствует принципам release management и GitFlow.

**Результат:**
Деплой выполняется только при сборке по тегу.

---

### 4.2 Лишний деплой и использование latest

**Проблема:**
- `Pipeline` сначала деплоил `latest`, затем обновлял образ до версии тега, что вызывало лишний деплой.

**Решение:**

- исключено использование `latest`
- исключён повторный `kubectl apply deployment.yaml` в deploy-шаге
- обновление выполняется единожды через `kubectl set image`

**Результат:**
- Исключён лишний деплой и перерыв в доступности приложения.

---

## 5. Итоги

- Все Ваши замечания учтены и проработаны.
- Работа приведена к более чистой, воспроизводимой и логически завершённой реализации с указанием учебных допущений.
- Финальный результат — рабочая DevOps-платформа, реализующая полный цикл: **Infrastructure → Kubernetes → CI/CD → Monitoring**, с соблюдением best practices и осознанными учебными допущениями.

---
